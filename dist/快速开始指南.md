# DCM-Nii 快速开始指南

## 🚀 选择您的版本

DCM-Nii 提供**三种**版本，请根据您的情况选择：

---

### ⭐ 便携版（强烈推荐）

**适合**: 医院环境、新手用户、无管理员权限的电脑  
**大小**: 118 MB（邮件分卷发送：3个45MB文件）  
**特点**: 
- ✅ **免安装Python** - 内置Python 3.10.11
- ✅ **预装依赖** - 所有包已配置好
- ✅ **开箱即用** - 解压即可运行
- ✅ **离线运行** - 无需网络
- ✅ **绿色版** - 不修改系统

#### 🚀 3步超快速开始（最简单！）

**第1步**: 获取并合并文件
- 如果是邮件接收：保存3个.rar文件到同一文件夹
- 双击 `DCM-Nii_portable.part1.rar`
- WinRAR自动合并所有分卷并解压

**第2步**: 解压便携版包
- 从part1.rar中解压出 `DCM-Nii_portable_*.zip`
- 将ZIP解压到任意目录（建议路径不包含中文）

**第3步**: 启动工具
- 双击 `Start_DCM-Nii.bat` 即可使用
- 选择需要的工具，立即开始处理DICOM数据

💡 **为什么选便携版？**
- 医院电脑往往没有管理员权限，不能安装Python
- USB端口被禁用，邮件是唯一的传输方式
- IT部门审批流程长，便携版规避这些限制
- 适合需要快速部署的场景

📧 **邮件分卷说明**：详见 `README_WINRAR.txt`

---

### 🖥️ 完整版（包含MRIcroGL）

**适合**: 需要医学影像查看器的用户  
**大小**: 65.38 MB  
**特点**: 包含MRIcroGL医学影像查看工具

#### 3步快速开始

**第1步**: 解压文件  
将 `DCM-Nii_full_*.zip` 解压到任意目录（建议路径不包含中文）

**第2步**: 安装环境（首次使用）  
双击运行 `setup_environment.bat`
- 自动检查Python环境
- 自动安装依赖包
- 等待2-5分钟完成

**第3步**: 开始使用  
双击运行 `start_tools.bat`，选择需要的工具：
1. 元数据提取工具（推荐第一步：了解数据概况）
2. DICOM脱敏工具（第二步：去除敏感信息）
3. DICOM转换工具（最大层数优先）
4. DICOM转换工具（5mm切片筛选）
5. 查看帮助文档

💡 **推荐工作流程**: 元数据提取 → DICOM脱敏 → NIfTI转换

---

### 🪶 轻量版

**适合**: Python开发者或有Python环境的用户  
**大小**: 0.56 MB  
**特点**: 最小体积，需要自行配置Python环境

#### 安装步骤

1. 解压文件
2. 安装Python依赖: `pip install -r requirements.txt`
3. 下载dcm2niix.exe到项目目录（或使用系统已安装的）
4. 运行Python脚本: `python src/xxxx.py`

---

## 📋 系统要求

### 便携版（免安装）
- ✅ **操作系统**: Windows 7/8/10/11（64位）
- ✅ **无需Python** - 已内置
- ✅ **无需管理员权限**
- ✅ **磁盘空间**: 300 MB（解压后）

### 完整版


- ✅ Windows 7/8/10/11
- ✅ Python 3.8+ （批处理版有自动安装）
- ✅ 2GB+ 磁盘空间
- ✅ 4GB+ 内存（推荐）

---

## 🔧 Python安装（如果没有）

1. 访问 https://www.python.org/downloads/
2. 下载 Python 3.10 或 3.11
3. 安装时**务必勾选**：
   - ☑ Add Python to PATH
   - ☑ Install pip
4. 测试安装：打开cmd运行 `python --version`

---

## ⚠️ 常见问题

### Q: 双击.bat文件没反应？
**A:** 右键 → "以管理员身份运行"

### Q: 提示"Python不是内部或外部命令"？
**A:** Python未安装或未添加到PATH，重新安装并勾选"Add Python to PATH"

### Q: pip安装依赖失败？
**A:** 使用国内镜像：
```
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

---

## 🎯 主要工具

| 工具 | 功能 | 适用场景 |
|------|------|---------|
| 元数据提取 | 提取DICOM元数据到CSV | 数据分析/质控（推荐第一步） |
| DICOM脱敏 | 移除患者敏感信息，支持自定义PatientID | 数据共享/科研（推荐第二步） |
| 最大层数转换 | DICOM→NIfTI，选最多层数 | 完整扫描数据（通用推荐） |
| 5mm切片转换 | DICOM→NIfTI，保留4.0-6.0mm切片 | 特定研究需求 |

**新功能亮点：**
- ✅ **智能ZIP解压复用**：已解压的ZIP自动复用，大幅缩短重跑时间
- ✅ **自定义PatientID编号**：支持自定义前缀、起始编号、位数（如PATIENT_0100）
- ✅ **智能错误汇总**：自动分类错误并生成详细日志（`failed_cases_*.txt`、`processing_errors_*.txt`）
- ✅ **实时进度显示**：大数据集处理时每100个文件显示进度
- ✅ **快速启动**：优化扫描逻辑，大目录下启动速度提升90%+

---

## 📁 目录结构

```
DCM-Nii/
├── start_tools.bat          # 工具启动器（双击运行）
├── setup_environment.bat    # 环境安装器（首次运行）
├── README.md               # 详细文档
├── requirements.txt        # Python依赖
├── dcm2niix.exe           # 转换核心工具
├── src/                   # Python脚本
├── tools/                 # 辅助工具（含MRIcroGL）
└── docs/                  # 文档
```

---

## 💡 使用技巧

1. **推荐工作流程**：先提取元数据了解数据概况 → 再脱敏处理 → 最后转换NIfTI
2. **数据备份**：处理重要数据前先备份
3. **路径规范**：避免中文或特殊字符路径
4. **测试先行**：先用少量数据测试
5. **日志查看**：注意程序输出的日志信息，特别是错误汇总
6. **结果检查**：处理后检查output目录和错误日志文件
7. **自定义PatientID**：CLI模式使用 `--id-prefix PATIENT --id-start 100 --id-digits 4` 参数
8. **智能复用**：重跑相同数据时，已解压的ZIP会自动复用（提示"复用现有临时目录"）

---

## 🐛 错误处理

### 错误日志文件

处理完成后，如遇到错误，会自动生成以下文件：

- **`failed_cases_YYYYMMDD_HHMMSS.txt`** (NIfTI转换工具)
  - 按错误类型分类（DICOM文件问题、切片厚度不符、dcm2niix失败等）
  - 显示每类错误的案例列表（最多10例）
  - 包含详细错误堆栈和文件路径

- **`processing_errors_YYYYMMDD_HHMMSS.txt`** (脱敏工具)
  - 区分完全失败和部分失败案例
  - 记录每个案例的文件总数和具体错误
  - 便于定位问题案例

### 常见错误类型

| 错误类型 | 原因 | 解决方法 |
|---------|------|---------|
| DICOM文件问题 | 文件损坏或格式不正确 | 检查DICOM文件完整性 |
| 切片厚度不符 | 不在4.0-6.0mm范围 | 使用"最大层数优先"版本 |
| dcm2niix转换失败 | dcm2niix工具报错 | 查看详细日志，检查DICOM兼容性 |
| ZIP解压失败 | 压缩文件损坏 | 重新下载或检查ZIP文件 |
| 无有效DICOM文件 | 目录下无DICOM文件 | 确认目录包含.dcm文件 |

---

## 📞 获取帮助

- 📖 详细文档：`README.md`
- 🐛 问题反馈：[GitHub Issues](https://github.com/chenqz-hub/DCM-Nii-20251001/issues)
- 📧 项目主页：https://github.com/chenqz-hub/DCM-Nii-20251001

---

**感谢使用 DCM-Nii 工具集！**
